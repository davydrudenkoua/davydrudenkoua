<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-aks/aks-scaling" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.1">
<title data-rh="true">Scaling AKS with Cluster Autoscaler and KEDA | Davyd&#x27;s blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://davydrudenkoua.github.io/img/profile-pic.jpg"><meta data-rh="true" name="twitter:image" content="https://davydrudenkoua.github.io/img/profile-pic.jpg"><meta data-rh="true" property="og:url" content="https://davydrudenkoua.github.io/docs/aks/aks-scaling/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Scaling AKS with Cluster Autoscaler and KEDA | Davyd&#x27;s blog"><meta data-rh="true" name="description" content="Introduction"><meta data-rh="true" property="og:description" content="Introduction"><link data-rh="true" rel="canonical" href="https://davydrudenkoua.github.io/docs/aks/aks-scaling/"><link data-rh="true" rel="alternate" href="https://davydrudenkoua.github.io/docs/aks/aks-scaling/" hreflang="en"><link data-rh="true" rel="alternate" href="https://davydrudenkoua.github.io/docs/aks/aks-scaling/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.9476f55b.css">
<script src="/assets/js/runtime~main.a76c838f.js" defer="defer"></script>
<script src="/assets/js/main.38d2d924.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile-pic.jpg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/profile-pic.jpg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Davyd&#x27;s blog</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/kubernetes/">Tutorials</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/davydrudenkoua" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/kubernetes/">Kubernetes</a><button aria-label="Collapse sidebar category &#x27;Kubernetes&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/aks/aks-scaling/">Scaling AKS with Cluster Autoscaler and KEDA</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/aks/aks-workload-identity/">Using Workload Identities in Azure Kubernetes Service</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/kubernetes/"><span itemprop="name">Kubernetes</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Scaling AKS with Cluster Autoscaler and KEDA</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Scaling AKS with Cluster Autoscaler and KEDA</h1></header>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h3>
<p>Azure Kubernetes Service (AKS) provides a managed Kubernetes cluster with all
the features of a self-hosted install and plays super nicely with other Azure technology.
For example, we&#x27;ve explored Workload Identities in <a href="https://davydrudenkoua.github.io/docs/aks/aks-workload-identity/" target="_blank" rel="noopener noreferrer">the previous post</a> - an AKS
capability that allows developers to use Azure&#x27;s RBAC for authentication instead of connection strings and secrets.
As traffic to your application fluctuates, you might want to reduce costs during downtime and get peak performance during high load periods.
Luckily, in AKS you can enable KEDA with just one CLI switch and configure your pods scaling with just a few lines of YAML.
In this post we&#x27;ll see how we can scale pods and nodes using <strong>K</strong>ubernetes <strong>E</strong>vent <strong>D</strong>riven <strong>A</strong>utoscaler and Cluster Autoscaler.
You can all source code used in this tutorial in one place in the <a href="https://github.com/davydrudenkoua/k8s-keda-ca-scaling" target="_blank" rel="noopener noreferrer">post&#x27;s github repo</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="keda">KEDA<a href="#keda" class="hash-link" aria-label="Direct link to KEDA" title="Direct link to KEDA">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="basic-idea">Basic idea<a href="#basic-idea" class="hash-link" aria-label="Direct link to Basic idea" title="Direct link to Basic idea">​</a></h4>
<p>The most basic tool for scaling pods is <strong>H</strong>orizontal <strong>P</strong>od <strong>A</strong>utoscaler or HPA that enables
horizontal pod scaling based on CPU or Memory utilization.
However, most modern applications have far more complex needs - for example, you might want to scale based on the amount of
messages in Service Bus, results of a MongoDB or Prometheus query or count of blobs in Azure Blob Storage - in other words, some external event.
This is where <a href="https://keda.sh/" target="_blank" rel="noopener noreferrer">KEDA</a> with its vast selection of <a href="https://keda.sh/docs/2.16/scalers/" target="_blank" rel="noopener noreferrer">Scalers</a> comes in,
and if you can&#x27;t find what you are looking for there you can create your own.
Key difference between KEDA and HPA is the scaling trigger - HPA scales your pods when they are in need of more resources
while KEDA creates new pods when some event occurs. KEDA works alongside HPA, monitoring desired event source and feeding data to HPA driving scale out/in.
More detailed overview of KEDA architecture can be found on their <a href="https://keda.sh/docs/2.16/concepts/" target="_blank" rel="noopener noreferrer">documentation page</a>.</p>
<p>KEDA contains two main components, which are represented as pods in <code>kube-system</code> namespace in AKS cluster.</p>
<ul>
<li>KEDA Metrics API Server (<code>keda-metrics-apiserver</code> pod) collects metrics from external sources that are consumed by keda-operator to drive scaling in or out.</li>
<li>KEDA operator (<code>keda-operator</code> pod) acts as a scaling mastermind, ingesting metrics from <code>keda-metrics-apiserver</code> and feeding that data to <code>HPA</code> which adjusts the number of pods.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="configuring-what-and-how-to-scale">Configuring what and how to scale<a href="#configuring-what-and-how-to-scale" class="hash-link" aria-label="Direct link to Configuring what and how to scale" title="Direct link to Configuring what and how to scale">​</a></h4>
<p>To scale a kubernetes resource - it can even be a custom resource, although most often workloads are scaled using <code>Deployments</code> or <code>StatefulSets</code>,
you need to define a <code>ScaledObject</code>. The <code>ScaledObject</code> custom resource is a basic piece of configuration, describing what, when and how do you want to scale.
Full <code>ScaledObject</code> CRD definition can be found on <a href="https://keda.sh/docs/2.14/concepts/scaling-deployments/#scaledobject-spec" target="_blank" rel="noopener noreferrer">its documentation page</a>.</p>
<p>Another key resource is <code>TriggerAuthentication</code> which describes how KEDA should authenticate against your event source. It enables you to use not only most basic authentication methods like connection string, but also more advances mechanisms like <code>pod/workload identity</code>. Its CRD definition <a href="https://keda.sh/docs/2.14/concepts/authentication/#re-use-credentials-and-delegate-auth-with-triggerauthentication" target="_blank" rel="noopener noreferrer">can be found here</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="aks-cluster-autoscaler">AKS Cluster Autoscaler<a href="#aks-cluster-autoscaler" class="hash-link" aria-label="Direct link to AKS Cluster Autoscaler" title="Direct link to AKS Cluster Autoscaler">​</a></h3>
<p>AKS Cluster Autoscaler is a component that monitors cluster for pending pods.  When it finds a pod that can&#x27;t be created in any of the existing nodes, it creates new ones. It is worth noting that when you enable <code>Cluster Autoscaler</code>, manual scaling becomes unavailable. Because AKS operates on <code>VM Scale Sets</code>, provisioning new VMs can take some time -- around a few minutes. By default, Autoscaler expects new nodes to be provisioned in 15 minutes but you can tweak that when you enable it. You can find all available options for configuring CA on the <a href="https://learn.microsoft.com/en-us/azure/aks/cluster-autoscaler?tabs=azure-cli#cluster-autoscaler-profile-settings" target="_blank" rel="noopener noreferrer">documentation page</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="explaining-the-setup">Explaining the setup<a href="#explaining-the-setup" class="hash-link" aria-label="Direct link to Explaining the setup" title="Direct link to Explaining the setup">​</a></h3>
<p>In this post we will be deploying a single Docker container containing a simple Python 3.10 app.
The app connects to an Azure Service Bus Queue and echoes all received messages to the console.
To simplify config management and for security both KEDA and the python application be using Azure Workload Identity.
Python app pods will be scaled by KEDA based on the count of messages in Service Bus Queue and when there are not enough resources on existing node, new node will be created by Cluster Autoscaler.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> azure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">servicebus </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> ServiceBusClient</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> azure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">identity </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> DefaultAzureCredential</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">QUEUE_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;scaling-queue&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SERVICEBUS_NAMESPACE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;k8s-scaling-demo-sb-01.servicebus.windows.net&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HOSTNAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;HOSTNAME&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># AKS pod name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">receive_messages</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> ServiceBusClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SERVICEBUS_NAMESPACE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DefaultAzureCredential</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> sb_client</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> sb_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_queue_receiver</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">QUEUE_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> queue_receiver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Successfully connected to and listening for messages from queue </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">QUEUE_NAME</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> message </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> queue_receiver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">receive_messages</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">max_message_count</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> max_wait_time</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Pod </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">HOSTNAME</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> received new message #</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">message</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">sequence_number</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">str</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">message</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, beginning processing&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Pod </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">HOSTNAME</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> processed message #</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">message</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">sequence_number</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          queue_receiver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">complete_message</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;__main__&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          receive_messages</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> exception</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Exception raised while listening to messages: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">repr</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">exception</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="setting-up-aks">Setting up AKS<a href="#setting-up-aks" class="hash-link" aria-label="Direct link to Setting up AKS" title="Direct link to Setting up AKS">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h4>
<ul>
<li>Azure Subscription</li>
<li>Service Account with a single Queue</li>
<li>Azure CLI &gt;= 2.47.0</li>
<li>aks-preview Azure CLI extension &gt;= 9.0.0b7</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="function-to-create-user-assigned-managed-identity">Function to create User-Assigned Managed Identity<a href="#function-to-create-user-assigned-managed-identity" class="hash-link" aria-label="Direct link to Function to create User-Assigned Managed Identity" title="Direct link to Function to create User-Assigned Managed Identity">​</a></h4>
<p>Because we will need two managed identities for KEDA and the app itself, common part can be extracted to reusable function.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Add-UserIdentity</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">param</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token namespace" style="opacity:0.7">[Parameter(Mandatory)]</span><span class="token namespace" style="opacity:0.7">[string]</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$Subscription</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token namespace" style="opacity:0.7">[Parameter(Mandatory)]</span><span class="token namespace" style="opacity:0.7">[string]</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$ResourceGroupName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token namespace" style="opacity:0.7">[Parameter(Mandatory)]</span><span class="token namespace" style="opacity:0.7">[string]</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$Location</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token namespace" style="opacity:0.7">[Parameter(Mandatory)]</span><span class="token namespace" style="opacity:0.7">[string]</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$UserAssignedIdentityName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token namespace" style="opacity:0.7">[Parameter(Mandatory)]</span><span class="token namespace" style="opacity:0.7">[string]</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$ServiceBusNamespace</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token namespace" style="opacity:0.7">[Parameter(Mandatory)]</span><span class="token namespace" style="opacity:0.7">[string]</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$ServiceBusRole</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    az identity create `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">name </span><span class="token variable" style="color:#36acaa">$UserAssignedIdentityName</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">resource-</span><span class="token function" style="color:#d73a49">group</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$ResourceGroupName</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">location </span><span class="token variable" style="color:#36acaa">$Location</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token variable" style="color:#36acaa">$UserAssignedIdentityClientId</span><span class="token plain"> = $</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">az identity show </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">resource-</span><span class="token function" style="color:#d73a49">group</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$ResourceGroupName</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">name </span><span class="token variable" style="color:#36acaa">$UserAssignedIdentityName</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">query </span><span class="token string" style="color:#e3116c">&#x27;clientId&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o tsv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token variable" style="color:#36acaa">$ServiceBusId</span><span class="token plain"> = $</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">az servicebus namespace show </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">name </span><span class="token variable" style="color:#36acaa">$ServiceBusNamespace</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">resource-</span><span class="token function" style="color:#d73a49">group</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$ResourceGroupName</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">query </span><span class="token string" style="color:#e3116c">&quot;id&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o tsv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    az role assignment create `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">assignee </span><span class="token variable" style="color:#36acaa">$UserAssignedIdentityClientId</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">role </span><span class="token variable" style="color:#36acaa">$ServiceBusRole</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">scope </span><span class="token variable" style="color:#36acaa">$ServiceBusId</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain">  @</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ClientId = </span><span class="token variable" style="color:#36acaa">$UserAssignedIdentityClientId</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TenantId = $</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">az identity show </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">resource-</span><span class="token function" style="color:#d73a49">group</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$ResourceGroupName</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">name </span><span class="token variable" style="color:#36acaa">$UserAssignedIdentityName</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">query </span><span class="token string" style="color:#e3116c">&#x27;tenantId&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">otsv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="creating-necessary-variables">Creating necessary variables<a href="#creating-necessary-variables" class="hash-link" aria-label="Direct link to Creating necessary variables" title="Direct link to Creating necessary variables">​</a></h4>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token variable" style="color:#36acaa">$ResourceGroupName</span><span class="token plain"> = </span><span class="token string" style="color:#e3116c">&quot;k8s-scaling-demo&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$ClusterName</span><span class="token plain"> = </span><span class="token string" style="color:#e3116c">&quot;aks-scaling-demo&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$KedaFederatedIdentityName</span><span class="token plain"> = </span><span class="token string" style="color:#e3116c">&quot;keda-federated-identity&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$QueueListenerFederatedIdentityName</span><span class="token plain"> = </span><span class="token string" style="color:#e3116c">&quot;queue-listener-federated-identity&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$KedaUserAssignedIdentityName</span><span class="token plain"> = </span><span class="token string" style="color:#e3116c">&quot;keda-user-assigned-identity&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$QueueListenerUserAssignedIdentityName</span><span class="token plain">=</span><span class="token string" style="color:#e3116c">&quot;queue-listener-user-assigned-identity&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$QueueListenerServiceAccountName</span><span class="token plain"> = </span><span class="token string" style="color:#e3116c">&quot;queue-listener&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$Location</span><span class="token plain"> = $</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">az </span><span class="token function" style="color:#d73a49">group</span><span class="token plain"> show </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">name </span><span class="token variable" style="color:#36acaa">$ResourceGroupName</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">query </span><span class="token string" style="color:#e3116c">&quot;location&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o tsv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$SubscriptionId</span><span class="token plain"> = $</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">az account show </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">query </span><span class="token string" style="color:#e3116c">&quot;id&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">output tsv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$ScalingQueueName</span><span class="token plain"> =</span><span class="token string" style="color:#e3116c">&quot;scaling-queue&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$ScalingQueueNamespace</span><span class="token plain"> = </span><span class="token string" style="color:#e3116c">&quot;k8s-scaling-demo-sb-01&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$DockerUsername</span><span class="token plain"> = </span><span class="token variable" style="color:#36acaa">$Env</span><span class="token plain">:DOCKER_USERNAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$DockerPassword</span><span class="token plain"> = </span><span class="token variable" style="color:#36acaa">$Env</span><span class="token plain">:DOCKER_PASSWORD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$DockerServer</span><span class="token plain"> = </span><span class="token string" style="color:#e3116c">&quot;https://index.docker.io/v1/&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="aks-creation-and-setup">AKS Creation and Setup<a href="#aks-creation-and-setup" class="hash-link" aria-label="Direct link to AKS Creation and Setup" title="Direct link to AKS Creation and Setup">​</a></h4>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Creating AKS&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az aks create `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">resource-</span><span class="token function" style="color:#d73a49">group</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$ResourceGroupName</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">name </span><span class="token variable" style="color:#36acaa">$ClusterName</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token function" style="color:#d73a49">enable-oidc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">issuer `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token function" style="color:#d73a49">enable-workload</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">identity `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token function" style="color:#d73a49">enable-keda</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">generate-ssh-keys `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">location </span><span class="token variable" style="color:#36acaa">$Location</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">node-vm-size </span><span class="token string" style="color:#e3116c">&quot;Standard_B2s&quot;</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">tier </span><span class="token string" style="color:#e3116c">&quot;free&quot;</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">node-count 1 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token function" style="color:#d73a49">enable-cluster</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">autoscaler ` </span><span class="token comment" style="color:#999988;font-style:italic"># CA parameters start here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">min-count 1 `               </span><span class="token comment" style="color:#999988;font-style:italic"># Lowest possible node count</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">max-count 2 `               </span><span class="token comment" style="color:#999988;font-style:italic"># Highest possible node count</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">cluster-autoscaler-profile scan-interval=30s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ` </span><span class="token comment" style="color:#999988;font-style:italic"># Check for underutilized nodes/scheduled pods every 30s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max-graceful-termination-sec=30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max-node-provision-time=15m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">new-pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">scale-up-delay=10s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> `                 </span><span class="token comment" style="color:#999988;font-style:italic"># Ignore unscheduled pods before they are 10s old</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            scale-down-utilization-threshold=0</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> `       </span><span class="token comment" style="color:#999988;font-style:italic"># Sum of requested resources divided by capacity below which node can be removed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            scale-down-unneeded-time=1m                   </span><span class="token comment" style="color:#999988;font-style:italic"># How long a node should be unneeded before it&#x27;s eligible for scale down</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az aks </span><span class="token function" style="color:#d73a49">get-credentials</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">name </span><span class="token variable" style="color:#36acaa">$ClusterName</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">resource-</span><span class="token function" style="color:#d73a49">group</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$ResourceGroupName</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$AksOidcIssuer</span><span class="token plain"> = $</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    az aks show `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">name </span><span class="token variable" style="color:#36acaa">$ClusterName</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">resource-</span><span class="token function" style="color:#d73a49">group</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$ResourceGroupName</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">query </span><span class="token string" style="color:#e3116c">&quot;oidcIssuerProfile.issuerUrl&quot;</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o tsv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;AKS </span><span class="token string variable" style="color:#36acaa">$ClusterName</span><span class="token string" style="color:#e3116c"> created and connected to kubectl&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#Creating secret to pull Docker image from private registry</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create secret docker-registry queue-listener-registry-secret `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">docker-server </span><span class="token variable" style="color:#36acaa">$DockerServer</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">docker-username </span><span class="token variable" style="color:#36acaa">$DockerUsername</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">docker-password </span><span class="token variable" style="color:#36acaa">$DockerPassword</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="creating-keda-and-application-identity">Creating KEDA and application identity<a href="#creating-keda-and-application-identity" class="hash-link" aria-label="Direct link to Creating KEDA and application identity" title="Direct link to Creating KEDA and application identity">​</a></h4>
<p>Both <code>KEDA</code> and <code>queue-listener</code> are using <code>AKS Workload Identity</code> to authenticate against Service Bus Queue, so we are assigning RBAC roles accordingly.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Creating user-assigned keda identity&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$KedaIdentityParams</span><span class="token plain"> = @</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Subscription = </span><span class="token variable" style="color:#36acaa">$SubscriptionId</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ResourceGroupName = </span><span class="token variable" style="color:#36acaa">$ResourceGroupName</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Location = </span><span class="token variable" style="color:#36acaa">$Location</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UserAssignedIdentityName = </span><span class="token variable" style="color:#36acaa">$KedaUserAssignedIdentityName</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServiceBusNamespace = </span><span class="token variable" style="color:#36acaa">$ScalingQueueNamespace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServiceBusRole = </span><span class="token string" style="color:#e3116c">&quot;Azure Service Bus Data Owner&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$KedaUserAssignedIdentityValues</span><span class="token plain"> = </span><span class="token function" style="color:#d73a49">Add-UserIdentity</span><span class="token plain"> @KedaIdentityParams</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az identity federated-credential create `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token plain">name </span><span class="token variable" style="color:#36acaa">$KedaFederatedIdentityName</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token plain">identity-name </span><span class="token variable" style="color:#36acaa">$KedaUserAssignedIdentityName</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token plain">resource-</span><span class="token function" style="color:#d73a49">group</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$ResourceGroupName</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token plain">issuer </span><span class="token variable" style="color:#36acaa">$AksOidcIssuer</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token plain">subject system:serviceaccount:kube-system:keda-operator `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token plain">audience api:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">AzureADTokenExchange</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;User-assigned keda identity created&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Creating user-assigned queue-listener identity&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$QueueListenerIdentityParams</span><span class="token plain"> = @</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Subscription = </span><span class="token variable" style="color:#36acaa">$SubscriptionId</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ResourceGroupName = </span><span class="token variable" style="color:#36acaa">$ResourceGroupName</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Location = </span><span class="token variable" style="color:#36acaa">$Location</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UserAssignedIdentityName = </span><span class="token variable" style="color:#36acaa">$QueueListenerUserAssignedIdentityName</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServiceBusNamespace = </span><span class="token variable" style="color:#36acaa">$ScalingQueueNamespace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServiceBusRole = </span><span class="token string" style="color:#e3116c">&quot;Azure Service Bus Data Receiver&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$QueueListenerUserAssignedIdentityValues</span><span class="token plain"> = </span><span class="token function" style="color:#d73a49">Add-UserIdentity</span><span class="token plain"> @QueueListenerIdentityParams</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az identity federated-credential create `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">name </span><span class="token variable" style="color:#36acaa">$QueueListenerFederatedIdentityName</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">identity-name </span><span class="token variable" style="color:#36acaa">$QueueListenerUserAssignedIdentityName</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">resource-</span><span class="token function" style="color:#d73a49">group</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$ResourceGroupName</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">issuer </span><span class="token variable" style="color:#36acaa">$AksOidcIssuer</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">subject system:serviceaccount:default:</span><span class="token variable" style="color:#36acaa">$QueueListenerServiceAccountName</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">audience api:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">AzureADTokenExchange</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;User-assigned queue-listener identity created&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="applying-service-account-template-for-the-app">Applying Service Account template for the app<a href="#applying-service-account-template-for-the-app" class="hash-link" aria-label="Direct link to Applying Service Account template for the app" title="Direct link to Applying Service Account template for the app">​</a></h4>
<p>Application&#x27;s Service Account is really simple and is needed to bind pod to existing User-Assigned Managed Identity.
<code>{{QUEUE_LISTENER_USER_ASSIGNED_CLIENT_ID}}</code> will be replaced by an actual value later in the script when the template is actually applied.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">azure.workload.identity/client-id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">QUEUE_LISTENER_USER_ASSIGNED_CLIENT_ID</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> queue</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">listener</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Configuring and applying the template:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Creating queue-listener service account&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$QueueListenerServiceAccountTemplate</span><span class="token plain"> = </span><span class="token function" style="color:#d73a49">Get-Content</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Path </span><span class="token string" style="color:#e3116c">&quot;k8s/service-accounts/queue-listener.service-account.yaml&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Raw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$QueueListenerServiceAccountTemplate</span><span class="token plain"> = </span><span class="token variable" style="color:#36acaa">$QueueListenerServiceAccountTemplate</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-replace</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;{{QUEUE_LISTENER_USER_ASSIGNED_CLIENT_ID}}&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$QueueListenerUserAssignedIdentityValues</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$QueueListenerServiceAccountTemplate</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> kubectl apply </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Queue-listener service account created&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="restarting-keda-to-enable-workload-identity">Restarting keda to enable Workload Identity<a href="#restarting-keda-to-enable-workload-identity" class="hash-link" aria-label="Direct link to Restarting keda to enable Workload Identity" title="Direct link to Restarting keda to enable Workload Identity">​</a></h4>
<p>This needs to be done because even though AKS was created with Workload Identity enabled, KEDA didn&#x27;t start using it and needs to be restarted.</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart deploy keda-operator </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n kube-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="applying-application-deployment-template">Applying Application deployment template<a href="#applying-application-deployment-template" class="hash-link" aria-label="Direct link to Applying Application deployment template" title="Direct link to Applying Application deployment template">​</a></h4>
<p>The actual deployment has only one pod running a Docker image from private registry and it will be automatically scaled by KEDA.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  queue</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">listener</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  queue</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">listener</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> queue</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">listener</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  queue</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">listener</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">azure.workload.identity/use</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">serviceAccountName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> queue</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">listener</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  queue</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">listener</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  davydrudenkoua/queue</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">listener</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">requests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 300m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 300Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">limits</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 300m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 300Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">imagePullSecrets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> queue</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">listener</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">registry</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">secret</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Creating queue-listener deployment&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f </span><span class="token string" style="color:#e3116c">&quot;k8s/deployments/queue-listener.deployment.yaml&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Queue-listener deployment created&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploying-keda-scaled-object">Deploying KEDA scaled object<a href="#deploying-keda-scaled-object" class="hash-link" aria-label="Direct link to Deploying KEDA scaled object" title="Direct link to Deploying KEDA scaled object">​</a></h4>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> keda.sh/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TriggerAuthentication </span><span class="token comment" style="color:#999988;font-style:italic"># CRD that defines Workload Identity authentication to be used for scaling</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> queue</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">listener</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">sb</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">podIdentity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">provider</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> azure</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">workload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">identityId</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">KEDA_USER_ASSIGNED_IDENTITY_CLIENT_ID</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> keda.sh/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ScaledObject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> queue</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">listener</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">sb</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">scaledobject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">scaleTargetRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment                </span><span class="token comment" style="color:#999988;font-style:italic"># Optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> queue</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">listener            </span><span class="token comment" style="color:#999988;font-style:italic"># Must be in the same namespace as the ScaledObject</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">minReplicaCount</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">maxReplicaCount</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">cooldownPeriod</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">15</span><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># The time in seconds to wait after the last</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token comment" style="color:#999988;font-style:italic"># trigger invocation before scaling in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">triggers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> azure</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">servicebus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">queueName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">SCALING_QUEUE_NAME</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">SCALING_QUEUE_NAMESPACE</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">messageCount</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;10&quot;</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Basically a number of messages one pod can reliably handle</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">activationMessageCount</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># Optional. The number of messages until KEDA activates the scaler.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token comment" style="color:#999988;font-style:italic"># For example, # if you have activationMessageCount: &quot;5&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token comment" style="color:#999988;font-style:italic"># and minReplicaCount: 0, KEDA won&#x27;t  create any pods if</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    </span><span class="token comment" style="color:#999988;font-style:italic"># there are less than 5 active messages</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">authenticationRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> queue</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">listener</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">sb</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Deploying queue-listener scaled object&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$ScaledObjectAccountTemplate</span><span class="token plain"> = </span><span class="token function" style="color:#d73a49">Get-Content</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Path </span><span class="token string" style="color:#e3116c">&quot;k8s/keda/queue-listener.scaled-object.yaml&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Raw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$ScaledObjectAccountTemplate</span><span class="token plain"> = </span><span class="token variable" style="color:#36acaa">$ScaledObjectAccountTemplate</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-replace</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;{{KEDA_USER_ASSIGNED_IDENTITY_CLIENT_ID}}&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$KedaUserAssignedIdentityValues</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$ScaledObjectAccountTemplate</span><span class="token plain"> = </span><span class="token variable" style="color:#36acaa">$ScaledObjectAccountTemplate</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-replace</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;{{SCALING_QUEUE_NAME}}&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$ScalingQueueName</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$ScaledObjectAccountTemplate</span><span class="token plain"> = </span><span class="token variable" style="color:#36acaa">$ScaledObjectAccountTemplate</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-replace</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;{{SCALING_QUEUE_NAMESPACE}}&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$ScalingQueueNamespace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$ScaledObjectAccountTemplate</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> kubectl apply </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Queue-listener scaled object created&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="useful-commands">Useful commands<a href="#useful-commands" class="hash-link" aria-label="Direct link to Useful commands" title="Direct link to Useful commands">​</a></h3>
<p>Get AKS CA logs</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get events </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">field-selector source=cluster-autoscaler</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Watching pod logs in real-time</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl logs &lt;pod-name&gt; </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">follow</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Getting KEDA logs</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pod </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n kube-system </span><span class="token comment" style="color:#999988;font-style:italic"># locate keda-operator pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl logs &lt;keda-operator-pod-name&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Checking if workload identity is enabled for KEDA</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pod </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n kube-system </span><span class="token comment" style="color:#999988;font-style:italic"># locate keda-operator pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe pod &lt;keda-operator-pod-name&gt; </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n kube-system </span><span class="token comment" style="color:#999988;font-style:italic"># Look for AZURE_TENANT_ID,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                             </span><span class="token comment" style="color:#999988;font-style:italic"># AZURE_FEDERATED_IDENTITY_FILE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                             </span><span class="token comment" style="color:#999988;font-style:italic"># and AZURE_AUTHORITY_HOST variables</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/category/kubernetes/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Kubernetes</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/aks/aks-workload-identity/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Using Workload Identities in Azure Kubernetes Service</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#keda" class="table-of-contents__link toc-highlight">KEDA</a></li><li><a href="#aks-cluster-autoscaler" class="table-of-contents__link toc-highlight">AKS Cluster Autoscaler</a></li><li><a href="#explaining-the-setup" class="table-of-contents__link toc-highlight">Explaining the setup</a></li><li><a href="#setting-up-aks" class="table-of-contents__link toc-highlight">Setting up AKS</a></li><li><a href="#useful-commands" class="table-of-contents__link toc-highlight">Useful commands</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Davyd Rudenko. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>